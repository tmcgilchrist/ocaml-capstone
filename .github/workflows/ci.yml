name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  linux:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
        ocaml-compiler: ['4.14.x', '5.2.x']
        include:
          - os: ubuntu-latest
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: arm64

    runs-on: ${{ matrix.os }}
    name: Linux ${{ matrix.arch }} (OCaml ${{ matrix.ocaml-compiler }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config cmake
          # Build Capstone 5.x from source (Ubuntu 24.04 packages only have 4.x)
          git clone --depth 1 --branch 5.0.6 https://github.com/capstone-engine/capstone.git /tmp/capstone
          cd /tmp/capstone
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}

      - name: Install dependencies
        run: |
          # Use --no-depexts to prevent opam from installing libcapstone-dev (4.x)
          # which would overwrite our manually installed Capstone 5.x
          opam install . --deps-only --with-test --no-depexts -y

      - name: Check Capstone version
        run: |
          pkg-config --modversion capstone

      - name: Build
        run: |
          opam exec -- dune build

      - name: Run tests
        run: |
          opam exec -- dune test

  macos:
    strategy:
      fail-fast: false
      matrix:
        ocaml-compiler: ['4.14.x', '5.2.x']

    runs-on: macos-14
    name: macOS ARM64 (OCaml ${{ matrix.ocaml-compiler }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          brew install capstone pkg-config

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}

      - name: Install dependencies
        run: |
          opam install . --deps-only --with-test -y

      - name: Check Capstone version
        run: |
          pkg-config --modversion capstone

      - name: Build
        run: |
          opam exec -- dune build

      - name: Run tests
        run: |
          opam exec -- dune test
